function [ cable_info ] = pull_create_cable_forces( time, state, mesh )
%PULL_CREATE_CABLE_FORCES -- Computes cable forces and nodes to apply them to.
%
% INPUT:
%
%   time      - The current simulated time.
%   state     - The current state.
%   mesh      - The initial  mesh.
%
% OUTPUT:
%
% cable_info  - Upon return this struct will hold the cable force to apply
%               at every node, as well as the nodes to apply forces to and
%               their barycentric coordinates.
%
% Copyright 2011, Kenny Erleben
%
% Modified by Max Kragballe, 2019

%-- Get the current cable at time (t)
cable = state.cable;
T = mesh.T;  %-- Mesh tetrahedralization
X = mesh.x0; %-- Mesh x coordinates
Y = mesh.y0; %-- Mesh y coordinates
Z = mesh.z0; %-- Mesh z coordinates

%--- Barycentric weights where
%       Wij := The weight of node j in terms of the position of via point i
W = zeros(length(cable.Es(:, 1)), length(X(:, 1)));
%--- Cable forces at each point on the cable (in terms of (x,y,z) forces)
Fp = zeros(length(cable.Es(:, 1)), 3);

%-- Compute the cable forces given by
%       -k max(l - a*l0, 0)
P = zeros(length(cable.Es), 3); %-- Re-interpolated points of the cables
for p = 1:length(P(:, 1))
    i = T(cable.Es(p), 1);
    j = T(cable.Es(p), 2);
    k = T(cable.Es(p), 3);
    m = T(cable.Es(p), 4);
    
    w = cable.Bs(p, :);
    %--- Inserting the weights into W
    W(p, i) = w(1);
    W(p, j) = w(2);
    W(p, k) = w(3);
    W(p, m) = w(4);
    
    Pi = [X(i); Y(i); Z(i)];
    Pj = [X(j); Y(j); Z(j)];
    Pk = [X(k); Y(k); Z(k)];
    Pm = [X(m); Y(m); Z(m)];
    
    P(p, :) =  W(p, i) * Pi + W(p, j) * Pj + W(p, k) * Pk + W(p, m) * Pm;
end
ls = vecnorm(P(2:end, :) - P(1:end-1, :), 2, 2);       %-- Length of the individual cables

l  = sum(ls);                                          %-- Length of the entire cable
l0 = sum(cable.L0s);                                   %-- Length of cable at time t=0
alpha = 0.5;                                           %-- Control parameter
Fc = -cable.k * max(l - alpha * l0, 0);                %-- The cable forces (identical across the cable)

%--- Compute directions to apply forces
ds = zeros(length(P(:, 1))-1, 3);
for d = 1:length(ds(:, 1))
   ds(d, :) = (P(d+1, :) - P(d)) / ls(d);
end

%--- Add forces based on directions to Fp
for p = 1:length(Fp(:, 1))
    if p == 1
        
    else
    if ~(p == 1) && p == length(Fp(:, 1))
        Fp(p, :) = Fc .* 
    else
        Fp(p, :) = Fc .* (ds(p, :) - ds(p-1, :));
    end
    end
    end
end

%--- Bundle all info into one structure ----------------------------------
cable_info = struct(...
  'fx', fx, ...
  'fy', fy, ...
  'fz', fz ...
  );

end